<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <link rel="stylesheet" type="text/css" href="/main.css">
  <title>Our Menu | BitePair</title>
</head>
<body class="combined-menu">
  <header class="menu-header">
    <h1>Our Menu</h1>
    <p>Delicious food, refreshing drinks, and fine wines</p>
  </header>

  <main class="menu-container">
    <!-- Food Section -->
    <section class="menu-section">
      <div class="category-title">
        <h2><i class="fas fa-utensils"></i> Food</h2>
      </div>
      <div class="category-grid">
        <% food.forEach(item => { %>
          <article class="menu-card food-card">
            <div class="card-content">
              <h3><%= item.name %></h3>
              <p class="description"><%= item.description || '' %></p>
              
              <% if (item.allergens && item.allergens.length > 0) { %>
                <div class="allergens">
                  <span class="allergens-label">Allergens:</span>
                  <% item.allergens.forEach(allergen => { %>
                    <% if (allergen) { %>
                      <span class="allergen-tag" data-allergen="<%= allergen %>">
                        <%= allergen[0].toUpperCase() %>
                        <span class="tooltip"><%= allergen %></span>
                      </span>
                    <% } %>
                  <% }) %>
                </div>
              <% } %>
              
              <div class="card-footer">
                <span class="price">£<%= Number(item.price).toFixed(2) %></span>
                <button class="add-btn" data-id="<%= item.id %>" 
                        data-name="<%= item.name %>" 
                        data-price="<%= item.price %>">
                  <i class="fas fa-plus"></i> Add to Basket
                </button>
              </div>
            </div>
          </article>
        <% }) %>
      </div>
    </section>

    <!-- Drinks Section -->
    <section class="menu-section">
      <div class="category-title">
        <h2><i class="fas fa-glass-whiskey"></i> Drinks</h2>
      </div>
      <div class="category-grid">
        <% drinks.forEach(item => { %>
          <article class="menu-card drink-card">
            <div class="card-content">
              <h3><%= item.name %></h3>
              <p class="description"><%= item.description || '' %></p>
              
              <div class="card-footer">
                <span class="price">£<%= Number(item.price).toFixed(2) %></span>
                <button class="add-btn" data-id="<%= item.id %>"
                        data-name="<%= item.name %>" 
                        data-price="<%= item.price %>">
                  <i class="fas fa-plus"></i> Add to Basket
                </button>
              </div>
            </div>
          </article>
        <% }) %>
      </div>
    </section>

    <!-- Wine Section -->
    <% if (wine && wine.length > 0) { %>
      <section class="menu-section">
        <div class="category-title">
          <h2><i class="fas fa-wine-bottle"></i> Wine</h2>
        </div>
        <div class="category-grid">
          <% wine.forEach(item => { %>
            <article class="menu-card wine-card">
              <div class="card-content">
                <h3><%= item.name %></h3>
                <p class="description"><%= item.origin %></p>
                
                <div class="price-options">
                  <% if (item.glass_price) { %>
                    <div class="price-option">
                      <span class="size">Glass</span>
                      <span class="price">£<%= Number(item.glass_price).toFixed(2) %></span>
                    </div>
                  <% } %>
                  <% if (item.small_price) { %>
                    <div class="price-option">
                      <span class="size">small</span>
                      <span class="price">£<%= Number(item.small_price).toFixed(2) %></span>
                    </div>
                  <% } %>
                  <% if (item.medium_price) { %>
                    <div class="price-option">
                      <span class="size">medium</span>
                      <span class="price">£<%= Number(item.medium_price).toFixed(2) %></span>
                    </div>
                  <% } %>
                  <% if (item.large_price) { %>
                    <div class="price-option">
                      <span class="size">large</span>
                      <span class="price">£<%= Number(item.large_price).toFixed(2) %></span>
                    </div>
                  <% } %>
                  <% if (item.bottle_price) { %>
                    <div class="price-option highlight">
                      <span class="size">Bottle</span>
                      <span class="price">£<%= Number(item.bottle_price).toFixed(2) %></span>
                    </div>
                  <% } %>
                </div>
                
                <div class="card-footer">
                  <% if (item.glass_price) { %>
                    <button class="add-btn" data-id="<%= item.id %>" 
                            data-name="<%= item.name %> (Glass)" 
                            data-price="<%= item.glass_price %>">
                      <i class="fas fa-plus"></i> Add Glass
                    </button>
                  <% } %>
                  <% if (item.small_price) { %>
                    <button class="add-btn" data-id="<%= item.id %>_small"
                            data-name="<%= item.name %> (small)" 
                            data-price="<%= item.small_price %>">
                      <i class="fas fa-plus"></i> Add Small
                    </button>
                  <% } %>
                  <% if (item.medium_price) { %>
                    <button class="add-btn" data-id="<%= item.id %>_medium"
                            data-name="<%= item.name %> (medium)" 
                            data-price="<%= item.medium_price %>">
                      <i class="fas fa-plus"></i> Add Medium
                    </button>
                  <% } %>
                  <% if (item.large_price) { %>
                    <button class="add-btn" data-id="<%= item.id %>_large"
                            data-name="<%= item.name %> (large)" 
                            data-price="<%= item.large_price %>">
                      <i class="fas fa-plus"></i> Add Large
                    </button>
                  <% } %>
                  <% if (item.bottle_price) { %>
                    <button class="add-btn" data-id="<%= item.id %>_bottle"
                            data-name="<%= item.name %> (Bottle)" 
                            data-price="<%= item.bottle_price %>">
                      <i class="fas fa-plus"></i> Add Bottle
                    </button>
                  <% } %>
                </div>
              </div>
            </article>
          <% }) %>
        </div>
      </section>
    <% } %>
  </main>

  <div class="basket-floating">
    <a href="/basket" class="basket-btn">
      <i class="fas fa-shopping-basket"></i>
      <span class="basket-count">0</span>
    </a>
  </div>

  <script>
    document.addEventListener("click", async (e) => {
      const addBtn = e.target.closest(".add-btn");
      if (addBtn) {
        const id = addBtn.dataset.id;
        const name = addBtn.dataset.name;
        const price = parseFloat(addBtn.dataset.price);

        try {
          const response = await fetch("/basket/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id, name, price }),
          });

          if (response.ok) {

          const originalHtml = addBtn.innerHTML;
          addBtn.innerHTML = '<i class="fas fa-check"></i> Added!';
          addBtn.style.backgroundColor = '#4CAF50';


          updateBasketCount();

          try {
              const pairingRes = await fetch("pairing-ai", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ itemName: name }),
              });

              const pairingData = await pairingRes.json();

              if (pairingData.suggestion) {
                showPairingPopup(name, pairingData.suggestion);
              }
            } catch (err) {
              console.error("AI pairing fetch failed:", err);
          } 

          setTimeout(() => {
            addBtn.innerHTML = originalHtml;
            addBtn.style.backgroundColor = '';
          }, 1500);
        }

        } catch (error) {
          console.error("Error adding to basket:", error);
        }
      }
    });

  function showPairingPopup(selectedItem, suggestion) {
  const popup = document.createElement("div");
  popup.className = "pairing-popup centered";
  popup.innerHTML = `
    <div class="popup-content">
      <p>You just picked <strong>${selectedItem}</strong>.</p>
      <p>Try pairing it with <strong>${suggestion.name}</strong>.</p>
      <div class="popup-actions">
        <button class="popup-add-btn" 
                data-id="${suggestion.id}" 
                data-name="${suggestion.name}" 
                data-price="${suggestion.price}">
          <i class="fas fa-plus"></i> Add to Basket
        </button>
        <button class="popup-close-btn">No Thanks</button>
      </div>
    </div>
  `;
  document.body.appendChild(popup);

  popup.querySelector(".popup-add-btn").addEventListener("click", async (e) => {
    const btn = e.target.closest("button");
    const id = btn.dataset.id;
    const name = btn.dataset.name;
    const price = parseFloat(btn.dataset.price);

    try {
      const response = await fetch("/basket/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, name, price }),
      });

      if (response.ok) {
        updateBasketCount();
        popup.remove();
      }
    } catch (err) {
      console.error("Error adding suggestion to basket:", err);
    }
  });

  popup.querySelector(".popup-close-btn").addEventListener("click", () => {
    popup.remove();
  });
}
    async function updateBasketCount() {
      try {
        const response = await fetch("/basket/count");
        if (response.ok) {
          const data = await response.json();
          document.querySelector(".basket-count").textContent = data.count || 0;
        }
      } catch (error) {
        console.error("Error getting basket count:", error);
      }
    }

    document.addEventListener("DOMContentLoaded", updateBasketCount);

    document.querySelectorAll('.menu-card').forEach((card, index) => {
      card.style.animationDelay = `${index * 0.1}s`;
      card.classList.add('fadeInUp');
    });
  </script>
</body>
</html>